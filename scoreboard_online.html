<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kokky's Hot Spring Hop – Online Scoreboard</title>

<link href="https://fonts.googleapis.com/css2?family=Handjet:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
}

body {
  background: #000814;            /* BLACK SIDES */
  font-family: "Handjet", sans-serif;
  color: #ffffff;
  display: flex;
  justify-content: center;
}

/* ===== PAGE (MATCH GAME WIDTH) ===== */
.page {
  width: 100%;
  max-width: 480px;
  min-height: 100vh;
  position: relative;
  background: linear-gradient(#0A1633, #000814);
  overflow: hidden;
}

/* ===== STARS & SNOW (SCOPED TO PAGE) ===== */
.star,
.snow {
  position: absolute;
  pointer-events: none;
}

/* Stars */
.star {
  border-radius: 50%;
  opacity: 0.9;
}

/* Snow */
.snow {
  background: #ffffff;
  border-radius: 50%;
  opacity: 0.8;
  animation: fall linear infinite;
}

@keyframes fall {
  from { transform: translateY(-120px); }
  to   { transform: translateY(110vh); }
}

/* ===== SCOREBOARD CONTAINER ===== */
.container {
  max-width: 440px;
  margin: 30px auto;
  padding: 20px;
  background: rgba(10, 12, 28, 0.85);
  border-radius: 20px;
  border: 2px solid rgba(255,255,255,0.2);
  position: relative;
  z-index: 2;
  overflow: hidden;
}

.tableWrap {
  max-height: 55vh;          /* controls how tall the table can be */
  overflow-y: auto;          /* ENABLE SCROLL */
  margin-top: 20px;
  -webkit-overflow-scrolling: touch;
}

h1 {
  text-align: center;
  font-size: 1.5rem;   /* smaller, 1-line */
  font-weight: 400;
  margin-bottom: 6px;
  white-space: nowrap; /* force single line */
}

.sub {
  text-align: center;
  font-size: 1.1rem;
  opacity: 0.85;
}

table {
  width: 100%;
  margin-top: 0;
  border-collapse: collapse;
  font-size: 1.3rem;
}

th {
  padding: 12px;
  background: rgba(40, 50, 90, 0.9);
  border-bottom: 2px solid #ffffff33;
}

td {
  padding: 12px;
  text-align: center;
  border-bottom: 1px solid #ffffff22;
}

.backBtn {
  margin: 20px auto 0;
  display: block;
  padding: 12px 26px;
  font-size: 1.2rem;
  border-radius: 12px;
  background: #ff6b8b;
  color: #150818;
  border: none;
  cursor: pointer;
  font-family: "Handjet", sans-serif;
}

/* export button (admin only) */
.exportBtn {
  margin: 12px auto 0;
  display: none;
  padding: 12px 26px;
  font-size: 1.2rem;
  border-radius: 12px;
  background: #ffd966;
  color: #150818;
  border: none;
  cursor: pointer;
  font-family: "Handjet", sans-serif;
  font-weight: 700;
}
</style>
</head>

<body>

<div class="page">

  <div class="container">
    <h1>Kokky's Hot Spring Hop – Online Scoreboard</h1>

    <div class="sub" id="modeText">
  Top 15 overall scores<br>
  Offensive names will be deleted.<br>
  <span style="opacity:.85;">不適切な名前は削除します。</span>
</div>


    <button class="exportBtn" id="exportBtn">Export CSV</button>

    <div class="tableWrap">
      <table id="scoreTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Name</th>
            <th>High Score</th>
            <th>Best Rank</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <button class="backBtn" onclick="window.location.href='index.html'">
      Back to Game
    </button>
  </div>

</div>

<script type="module">
/* ===== FIREBASE ===== */
import { db } from "./firebase-init.js?v=20260204d";
import {
  collection,
  query,
  orderBy,
  limit,
  getDocsFromServer,
  getDocs
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";


/* ===== REFERENCE PAGE ===== */
const page = document.querySelector(".page");

/* ===== RANKS (SAME AS GAME) ===== */
const RANKS = [
  { score: 25,   name: "Steam Hopper" },
  { score: 50,   name: "Onsen Ace" },
  { score: 75,   name: "Steam Master" },
  { score: 100,  name: "Onsen Overlord" },
  { score: 250,  name: "King of the Onsen" },
  { score: 500,  name: "Onsen Legend" },
  { score: 1000, name: "Onsen God" }
];

function getRankForScore(score) {
  let best = "—";
  for (const r of RANKS) {
    if (score >= r.score) best = r.name;
  }
  return best;
}

function getRankStyle(rank) {
  switch (rank) {
    case "Steam Hopper":
      return { color: "#e6c97a", glow: "0 0 6px rgba(230,201,122,0.6)" };
    case "Onsen Ace":
      return { color: "#f0d98a", glow: "0 0 8px rgba(240,217,138,0.7)" };
    case "Steam Master":
      return { color: "#ffe29a", glow: "0 0 10px rgba(255,226,154,0.8)" };
    case "Onsen Overlord":
      return { color: "#fff2b0", glow: "0 0 14px rgba(255,242,176,0.9)" };
    case "King of the Onsen":
      return { color: "#ffd966", glow: "0 0 18px rgba(255,217,102,1)" };
    case "Onsen Legend":
      return { color: "#ffdf85", glow: "0 0 22px rgba(255,223,133,1)" };
    case "Onsen God":
      return { color: "#fff7cc", glow: "0 0 30px rgba(255,247,204,1.2)" };
    default:
      return { color: "#ffffff", glow: "none" };
  }
}

/* ===== CREATE STARS ===== */
for (let i = 0; i < 50; i++) {
  const s = document.createElement("div");
  s.className = "star";
  const size = Math.random() * 2 + 1;
  s.style.width = size + "px";
  s.style.height = size + "px";
  s.style.left = Math.random() * 100 + "%";
  s.style.top  = Math.random() * 60 + "%";
  s.style.background = Math.random() < 0.7 ? "#ffd966" : "#ffffff";
  page.appendChild(s);
}

/* ===== CREATE SNOW ===== */
for (let i = 0; i < 35; i++) {
  const f = document.createElement("div");
  f.className = "snow";
  const size = Math.random() * 3 + 2;
  f.style.width = size + "px";
  f.style.height = size + "px";
  f.style.left = Math.random() * 100 + "%";
  f.style.top = -(Math.random() * 120 + 20) + "px";
  f.style.animationDuration = (Math.random() * 5 + 6) + "s";
  f.style.animationDelay = Math.random() * 6 + "s";
  page.appendChild(f);
}

/* ===== MODE ===== */
const params = new URLSearchParams(location.search);
const isAdminMode = params.get("admin") === "1";

const exportBtn = document.getElementById("exportBtn");
if (isAdminMode) exportBtn.style.display = "block";

/* ===== LOAD ONLINE SCORES (TOP 15) ===== */
async function loadOnlineScores() {

 // IMPORTANT: public mode collection
const q = query(
  collection(db, "scores_public"),
  orderBy("score", "desc"),
  limit(15)
);

// FORCE server fetch (no cached results)
let snap;
try {
  snap = await getDocsFromServer(q);
} catch (e) {
  snap = await getDocs(q);
}

  if (snap.empty) {
  const tbody = document.querySelector("#scoreTable tbody");
  tbody.innerHTML = `<tr><td colspan="4">Can’t reach server. Try again.</td></tr>`;
  return;
}

const tbody = document.querySelector("#scoreTable tbody");
tbody.innerHTML = "";

let i = 0;
snap.forEach(docSnap => {
  i++;
  const entry = docSnap.data();

  const name = String(entry.name || "---");
  const sc = Number(entry.score || 0);

  const rankName = getRankForScore(sc);
  const rankStyle = getRankStyle(rankName);
  
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i}</td>
      <td style="font-weight: 700;">${name}</td>
      <td>${sc}</td>
      <td style="
        color: ${rankStyle.color};
        text-shadow: ${rankStyle.glow};
        font-weight: 600;
      ">${rankName}</td>
    `;
    tbody.appendChild(tr);
  });
}

loadOnlineScores();

/* ===== EXPORT CSV (ADMIN ONLY) ===== */
if (isAdminMode) {
  exportBtn.addEventListener("click", async () => {

    const qAll = query(
      collection(db, "scores_public"),
      orderBy("score", "desc"),
      limit(500)
    );

    const snapAll = await getDocsFromServer(qAll);

    const all = [];
    snapAll.forEach(d => {
      all.push({ key: d.id, ...d.data() });
    });

    const csv = [
      ["rank","docId","name","score","updatedAt"].join(","),
      ...all.map((r, idx) => {
        const key = String(r.key || "");
        const name = String(r.name || "");
        const score = Number(r.score || 0);
        const updatedAt = Number(r.updatedAt || 0);
        return [idx + 1, key, name, score, updatedAt].join(",");
      })
    ].join("\n");

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "kokky_scores_public.csv";
    a.click();

    URL.revokeObjectURL(url);
  });
}
</script>

</body>
</html>
